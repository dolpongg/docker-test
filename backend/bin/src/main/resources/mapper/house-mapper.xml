<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.myhome.model.repo.HouseDealDAO">


<!--

	
	
	List<HouseDeal> selectDeal(Connection con, String sidoName, String gugunName, String dongName) throws SQLException;
	
	List<House> selectHouse(Connection con, String sidoName, String gugunName, String dongName, int dealYear, int dealMonth, String page) throws SQLException;
	List<House> selectHouseDetail(Connection con, String sidoName, String gugunName, String dongName, int dealYear,
			int dealMonth, String APTName) throws SQLException;
	
	int avgAmount(Connection con, int low, int high) throws SQLException;
	
	Map<String,Integer> countLocation(Connection con, int amount) throws SQLException;
	String selectLocation(Connection con, String dongCode) throws SQLException;
	
	Map<Integer,Integer> avgBuild(Connection con, int amount, String dongCode) throws SQLException;
	List<House> selectHouses(Connection con, int amount, String dongCode, int buildYear) throws SQLException;
	  -->
	

<!-- List<String> selectGu(Connection con) throws SQLException; -->
    <select id="selectGu" resultType="String">
        select distinct(gugunName) as gugunName from dongcode  where substring(dongCode,1,4) in (select substring(dongCode,1,4) from dongcode where sidoName="서울특별시")
    </select>

    <!-- List<String> selectDong(Connection con, String gugun) throws SQLException;  -->
    <select id="selectDong" resultType="String" parameterType="string">
        select distinct(dongName) as dongName from dongcode  where substring(dongCode,1,8) in (select substring(dongCode,1,8) from dongcode where sidoName="서울특별시" and gugunName= #{gugun})
    </select>
    
    <!-- List<HouseInfo> selectInfo(Connection con, String sidoName, String gugunName, String dongName) throws SQLException; -->
    <select id="selectInfo" resultMap="baseHouseInfoMap" parameterType="map">
        select * from houseinfo where dongcode in (select dongCode from dongcode where sidoName= #{sidoName} and gugunName= #{gugunName} and dongName=#{dongName})
    </select>
    
    <!-- List<HouseDeal> selectDeal(Connection con, String sidoName, String gugunName, String dongName) throws SQLException; -->
    <select id="selectDeal" resultMap="baseHouseDealMap" parameterType="map">
        select * from housedeal where aptCode in (select aptCode from houseinfo where dongcode in (select dongCode from dongcode where sidoName= #{sidoName} and gugunName= #{gugunName} and dongName=#{dongName}))
    </select>
    
<!-- List<House> selectHouse(Connection con, String sidoName, String gugunName, String dongName, int dealYear, int dealMonth, String page) throws SQLException; -->
    <select id="selectHouse" resultMap="baseHouseMap" parameterType="map">
        select * from (select * from housedeal where aptCode in 
        (select aptCode from houseinfo where dongcode in 
        (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName} and dealYear=#{dealYear} and dealMonth = #{dealMonth}))) as deal inner join 
        (select * from houseinfo where dongcode in (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName})) as info using (aptCode) order by no desc limit #{page}, 3
    </select>
    
    <!-- List<House> selectHouseDetail(Connection con, String sidoName, String gugunName, String dongName, int dealYear, int dealMonth, String APTName) throws SQLException; -->
    <select id="selectHouseDetail" resultMap="baseHouseMap" parameterType="map">
        <if test="dealYear == 0">
            select * from (select * from housedeal where aptCode in 
            (select aptCode from houseinfo where dongcode in 
            (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName}))) as deal inner join 
            (select * from houseinfo where dongcode in (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName})) as info using (aptCode)
        </if>
        <if test="dealYear != 0">
            select * from (select * from housedeal where aptCode in 
            (select aptCode from houseinfo where dongcode in 
            (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName} and dealYear=#{dealYear} and dealMonth = #{dealMonth}))) as deal inner join 
            (select * from houseinfo where dongcode in (select dongCode from dongcode where sidoName=#{sidoName} and gugunName=#{gugunName} and dongName=#{dongName} and aptName=#{APTName})) as info using (aptCode)
        </if>
    </select>
    
    
    <!-- int avgAmount(Connection con, int low, int high) throws SQLException; -->
    <select id="avgAmount" resultType="int" parameterType="map">
        <![CDATA[      
            select round(avg(cast(replace(dealAmount, ',','') as unsigned)), -3) as avg from housedeal 
            where cast(replace(dealAmount, ',','') as unsigned) >= #{low} and cast(replace(dealAmount, ',','') as unsigned) <= #{high}
        ]]>
    </select>
    
    
    <!-- Map<String,Integer> countLocation(Connection con, int amount) throws SQLException; -->
    <select id="countLocation" resultType="map" parameterType="int">
        <![CDATA[  
            select dongCode, count(dongCode) as count from 
            (select * from housedeal where aptCode in 
            (select aptCode from houseinfo where dongcode in (select dongCode from dongcode))) as deal inner join 
            (select * from houseinfo where dongcode in 
            (select dongCode from dongcode)) as info using (aptCode) 
            where cast(replace(dealAmount, ',','') as unsigned) >= #{amount}-1000 and cast(replace(dealAmount, ',','') as unsigned) <= #{amount}+1000 group by dongCode
        ]]>
    </select>
    
    
    
    
    
    <!-- String selectLocation(Connection con, String dongCode) throws SQLException; -->
    <select id="selectLocation" resultType="String" parameterType="String">
        select dongName from dongcode where dongCode = #{dongCode}
    </select>
    
    <!-- Map<Integer,Integer> avgBuild(Connection con, int amount, String dongCode) throws SQLException; -->
    <select id="avgBuild" resultType="map" parameterType="map">
        <![CDATA[  
            select buildYear, count(buildYear) as count from 
            (select * from housedeal where aptCode in 
            (select aptCode from houseinfo where dongcode = #{dongCode})) as deal inner join 
            (select * from houseinfo where dongcode = #{dongCode}) as info using (aptCode) 
            where cast(replace(dealAmount, ',','') as unsigned) >= #{amount}-1000 and cast(replace(dealAmount, ',','') as unsigned) <= #{amount}+1000 group by buildYear
        ]]>
    </select>

    <!-- List<House> selectHouses(Connection con, int amount, String dongCode, int buildYear) throws SQLException; -->
    <select id="selectHouses" resultMap="baseHouseMap" parameterType="map">
        <![CDATA[  
            select * from (select * from housedeal where aptCode in 
            (select aptCode from houseinfo where dongcode = #{dongCode})) as deal inner join 
            (select * from houseinfo where dongcode = #{dongCode}) as info using (aptCode) 
            where cast(replace(dealAmount, ',','') as unsigned) >= #{amount}-1000 and cast(replace(dealAmount, ',','') as unsigned) <= #{amount}+1000 and buildYear = #{buildYear}
        ]]>
    </select>

	<resultMap type="house" id="baseHouseMap">
        <id column="aptCode" property="APTCode" />
        <result column="dealAmount" property="dealAmount" />
        <result column="dealYear" property="dealYear" />
        <result column="dealMonth" property="dealMonth" />
        <result column="dealDay" property="dealDay" />
        <result column="area" property="area" />
        <result column="floor" property="floor" />
        <result column="dongCode" property="dongCode" />
        <result column="dongName" property="dongName" />
        <result column="buildYear" property="buildYear" />
        <result column="jibun" property="jibun"/>
        <result column="aptName" property="APTName"/>
        <result column="lat" property="lat"/>
        <result column="lng" property="lng"/>
        <result column="sidoName" property="sidoName"/>
        <result column="gugunName" property="gugunName"/>
    </resultMap>
    
    
    <resultMap type="houseInfo" id="baseHouseInfoMap">
        <id column="aptCode" property="APTCode" />
        <result column="dongCode" property="dongCode" />
        <result column="dongName" property="dongName" />
        <result column="buildYear" property="buildYear" />
        <result column="jibun" property="jibun" />
        <result column="aptName" property="APTName" />
        <result column="lat" property="lat" />
        <result column="lng" property="lng" />
    </resultMap>

    <resultMap type="houseDeal" id="baseHouseDealMap">
        <id column="aptCode" property="APTCode" />
        <result column="dealAmount" property="dealAmount" />
        <result column="dealYear" property="dealYear" />
        <result column="dealMonth" property="dealMonth" />
        <result column="dealDay" property="dealDay" />
        <result column="area" property="area" />
        <result column="floor" property="floor" />
    </resultMap>


</mapper>